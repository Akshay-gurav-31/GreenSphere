<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> FasalMitra - Agricultural Assistant</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --background: 120 8% 97%;
            --foreground: 120 15% 12%;
            --card: 120 5% 99%;
            --primary: 120 45% 25%;
            --primary-foreground: 120 5% 98%;
            --primary-glow: 120 40% 35%;
            --secondary: 120 15% 92%;
            --muted: 120 10% 94%;
            --muted-foreground: 120 8% 45%;
            --border: 120 12% 88%;
            --input: 120 12% 88%;
            --ring: 120 45% 25%;
            --radius: 0.75rem;
        }

        .dark {
            --background: 120 15% 8%;
            --foreground: 120 8% 92%;
            --card: 120 12% 12%;
            --primary: 120 40% 65%;
            --primary-foreground: 120 15% 8%;
            --secondary: 120 15% 18%;
            --muted: 120 8% 18%;
            --muted-foreground: 120 5% 60%;
            --border: 120 8% 18%;
            --input: 120 8% 18%;
            --ring: 120 40% 65%;
        }

        /* Dynamic background based on theme */
        body {
            background: linear-gradient(180deg, hsl(var(--background)), hsl(var(--card))) !important;
            color: hsl(var(--foreground)) !important;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.dark {
            background: linear-gradient(180deg, hsl(120 15% 8%), hsl(120 12% 12%)) !important;
        }

        .bg-gradient-primary { background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-glow))); }
        .bg-gradient-nature { background: linear-gradient(180deg, hsl(120 25% 96%), hsl(120 15% 92%)); }
        .bg-gradient-earth { background: linear-gradient(45deg, hsl(120 20% 90%), hsl(110 25% 88%)); }
        .shadow-glow { box-shadow: 0 0 32px hsl(var(--primary-glow) / 0.3); }
        .card { border-radius: var(--radius); border: 1px solid hsl(var(--border)); background-color: hsl(var(--card)); }
        .btn { border-radius: calc(var(--radius) - 2px); font-weight: 500; cursor: pointer; border: none; padding: 0.5rem 1rem; }
        .btn-primary { background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-glow))); color: hsl(var(--primary-foreground)); }
        .btn-outline { background: transparent; border: 1px solid hsl(var(--border)); color: hsl(var(--foreground)); }
        .input { border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); background: hsl(var(--card)); padding: 0.5rem 0.75rem; color: hsl(var(--foreground)); width: 100%; transition: all 0.3s ease; }
        .select { border-radius: calc(var(--radius) - 2px); border: 1px solid hsl(var(--border)); background: hsl(var(--card)); padding: 0.5rem 0.75rem; color: hsl(var(--foreground)); width: 100%; transition: all 0.3s ease; }
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 50; display: flex; align-items: flex-end; }
        .modal-content { background-color: hsl(var(--card)); border-radius: var(--radius) var(--radius) 0 0; width: 100%; max-height: 85vh; overflow-y: auto; }
        .scrollarea { overflow-y: auto; scrollbar-width: thin; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 320px;
            background: hsl(var(--card));
            border-right: 1px solid hsl(var(--border));
            transition: transform 0.3s ease;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 1rem 1.5rem;
            background: hsl(var(--card));
            border-bottom: 1px solid hsl(var(--border));
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 80px);
        }
        
        .message-user {
            align-self: flex-end;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            margin: 0.5rem 1rem;
        }
        
        .message-assistant {
            align-self: flex-start;
            background: hsl(var(--muted));
            color: hsl(var(--foreground));
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            margin: 0.5rem 1rem;
        }
    </style>
</head>
<body style="min-height: 100vh;">
    <!-- Toast Container -->
    <div id="toast-container" style="position: fixed; top: 1rem; right: 1rem; z-index: 60; display: flex; flex-direction: column; gap: 0.5rem;"></div>
    
    <!-- Main Application -->
    <div id="app">
        <!-- Form View -->
        <div id="form-view" style="min-height: 100vh; padding: 1.5rem;">
            <div style="max-width: 64rem; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem;">
                <!-- Header -->
                <div class="card bg-gradient-primary shadow-glow" style="border: none; position: relative;">
                    <div style="padding: 1.5rem; text-align: center;">
                        <h1 style="font-size: 1.5rem; font-weight: bold; color: hsl(var(--primary-foreground)); display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <img src="../assets/images/logo.png" alt="FasalMitra Logo" style="width: 2rem; height: 2rem; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-flex';">
                                <i class="fas fa-leaf" style="display: none; color: hsl(var(--primary-foreground)); font-size: 1.5rem;"></i>
                                <span style="color: hsl(var(--primary-foreground)); font-weight: bold;">FasalMitra</span>
                            </div>
                            Agricultural Assistant
                        </h1>
                        <p style="color: hsl(var(--primary-foreground) / 0.9); font-size: 1.125rem;">Your AI-powered farming companion</p>
                        <button id="theme-toggle" onclick="toggleTheme()" style="position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 8px; color: white; cursor: pointer; transition: all 0.3s ease;">
                            <i data-lucide="sun" style="height: 1.25rem; width: 1.25rem;"></i>
                        </button>
                    </div>
                </div>

                <!-- Language Selection -->
                <div class="card" style="box-shadow: 0 8px 24px hsl(120 15% 12% / 0.12); background-color: hsl(var(--card) / 0.8);">
                    <div style="padding: 1rem; border-bottom: 1px solid hsl(var(--border));">
                        <h3 style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="globe" style="height: 1.25rem; width: 1.25rem; color: hsl(var(--primary));"></i>
                            Language Selection
                        </h3>
                    </div>
                    <div style="padding: 1rem;">
                        <select id="language-select" class="select">
                            <option value="en">English</option>
                            <option value="hi">हिंदी (Hindi)</option>
                            <option value="pa">ਪੰਜਾਬੀ (Punjabi)</option>
                            <option value="mr">मराठी (Marathi)</option>
                            <option value="kn">ಕನ್ನಡ (Kannada)</option>
                            <option value="ta">தமிழ் (Tamil)</option>
                            <option value="te">తెలుగు (Telugu)</option>
                            <option value="gu">ગુજરાતી (Gujarati)</option>
                        </select>
                    </div>
                </div>

                <!-- Mode Selection -->
                <div class="card" style="box-shadow: 0 8px 24px hsl(120 15% 12% / 0.12); background-color: hsl(var(--card) / 0.8);">
                    <div style="padding: 1rem; border-bottom: 1px solid hsl(var(--border));">
                        <h3 style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="settings" style="height: 1.25rem; width: 1.25rem; color: hsl(var(--primary));"></i>
                            Farming Mode
                        </h3>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <label id="mode-label" style="font-size: 0.875rem; font-weight: 500;">Simple Mode</label>
                                <p id="mode-description" style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                                    Basic farming guidance for all farmers
                                </p>
                            </div>
                            <label style="position: relative; display: inline-flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="mode-toggle" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">
                                <div id="toggle-bg" style="width: 2.75rem; height: 1.5rem; background-color: #d1d5db; border-radius: 9999px; position: relative; transition: background-color 0.2s;">
                                    <div id="toggle-dot" style="position: absolute; top: 2px; left: 2px; width: 1.25rem; height: 1.25rem; background-color: white; border-radius: 50%; transition: transform 0.2s;"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="card" style="box-shadow: 0 8px 24px hsl(120 15% 12% / 0.12); background-color: hsl(var(--card) / 0.8);">
                    <div style="padding: 1rem; border-bottom: 1px solid hsl(var(--border));">
                        <h3 style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="users" style="height: 1.25rem; width: 1.25rem; color: hsl(var(--primary));"></i>
                            Personal Information
                        </h3>
                    </div>
                    <div style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label for="nickname" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Farmer Name *</label>
                            <input type="text" id="nickname" placeholder="Enter your name" class="input" />
                        </div>
                    </div>
                </div>

                <!-- Location Information -->
                <div class="card" style="box-shadow: 0 8px 24px hsl(120 15% 12% / 0.12); background-color: hsl(var(--card) / 0.8);">
                    <div style="padding: 1rem; border-bottom: 1px solid hsl(var(--border));">
                        <h3 style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="map-pin" style="height: 1.25rem; width: 1.25rem; color: hsl(var(--primary));"></i>
                            Location Details
                        </h3>
                    </div>
                    <div style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label for="location-input" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">City or PIN Code *</label>
                            <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.75rem;">Enter city name (e.g., Mumbai) or PIN code (e.g., 400001)</p>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" id="location-input" placeholder="Enter city name or PIN code" class="input" style="flex: 1;" />
                                <button type="button" id="test-location-btn" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; cursor: pointer; font-size: 0.75rem; color: #6b7280;" title="Test locations">Test</button>
                            </div>
                        </div>
                        <div id="location-display" class="hidden" style="padding: 0.75rem; border-radius: 0.5rem; border: 1px solid hsl(var(--primary) / 0.2); background-color: hsl(var(--primary) / 0.1);">
                            <p id="location-text" style="font-size: 0.875rem; color: hsl(var(--primary)); font-weight: 500;"></p>
                        </div>
                    </div>
                </div>

                <!-- Farm Information -->
                <div class="card" style="box-shadow: 0 8px 24px hsl(120 15% 12% / 0.12); background-color: hsl(var(--card) / 0.8);">
                    <div style="padding: 1rem; border-bottom: 1px solid hsl(var(--border));">
                        <h3 style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="leaf" style="height: 1.25rem; width: 1.25rem; color: hsl(var(--primary));"></i>
                            Farm Details
                        </h3>
                    </div>
                    <div style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label for="landarea" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Land Area *</label>
                            <p style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.75rem;">Choose unit and enter area amount</p>
                            
                            <!-- Unit Selection First -->
                            <div style="margin-bottom: 0.75rem;">
                                <label for="landunit" style="display: block; font-size: 0.8rem; font-weight: 500; margin-bottom: 0.5rem; color: hsl(var(--primary));">Select Unit:</label>
                                <select id="landunit" class="select" onchange="updatePlaceholder()" style="width: 100%; padding: 0.75rem; border: 2px solid hsl(var(--primary) / 0.3); border-radius: 0.5rem; background: hsl(var(--background)); color: hsl(var(--foreground)); font-size: 0.9rem; font-weight: 500;">
                                    <option value="acres">Acres</option>
                                    <option value="hectares">Hectares</option>
                                    <option value="sq_feet">Square Feet</option>
                                    <option value="sq_meters">Square Meters</option>
                                    <option value="bigha">Bigha (Indian)</option>
                                    <option value="kanal">Kanal (Indian)</option>
                                    <option value="marla">Marla (Indian)</option>
                                </select>
                            </div>
                            
                            <!-- Amount Input Second -->
                            <div>
                                <label for="landarea" style="display: block; font-size: 0.8rem; font-weight: 500; margin-bottom: 0.5rem; color: hsl(var(--primary));">Enter Area Amount:</label>
                                <input 
                                    type="number" 
                                    id="landarea" 
                                    placeholder="Enter amount (e.g., 5.5)" 
                                    class="input" 
                                    min="0.01" 
                                    step="0.01" 
                                    style="width: 100%; 
                                           -webkit-appearance: auto; 
                                           -moz-appearance: auto; 
                                           appearance: auto; 
                                           padding: 0.75rem; 
                                           border: 2px solid hsl(var(--primary) / 0.3); 
                                           border-radius: 0.5rem; 
                                           background: hsl(var(--background)); 
                                           color: hsl(var(--foreground)); 
                                           font-size: 0.9rem;
                                           font-weight: 500;"
                                    oninput="showPreview()"
                                />
                            </div>
                            
                            <!-- Live Preview -->
                            <div id="area-preview" style="margin-top: 0.5rem; padding: 0.5rem; background: hsl(var(--primary) / 0.1); border-radius: 0.375rem; font-size: 0.8rem; color: hsl(var(--primary)); display: none;">
                                <strong>Preview:</strong> <span id="preview-text"></span>
                            </div>
                        </div>
                        <div>
                            <label for="soiltype" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Soil Type *</label>
                            <select id="soiltype" class="select">
                                <option value="">Select soil type</option>
                                <option value="Alluvial Soil">Alluvial Soil</option>
                                <option value="Black Soil (Regur)">Black Soil (Regur)</option>
                                <option value="Red Soil">Red Soil</option>
                                <option value="Laterite Soil">Laterite Soil</option>
                                <option value="Desert Soil">Desert Soil</option>
                                <option value="Mountain Soil">Mountain Soil</option>
                                <option value="Saline Soil">Saline Soil</option>
                                <option value="Peaty Soil">Peaty Soil</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Advanced Mode Fields -->
                <div id="advanced-fields" class="card hidden" style="box-shadow: 0 8px 24px hsl(120 15% 12% / 0.12); background-color: hsl(var(--card) / 0.8); border: 1px solid hsl(var(--primary) / 0.3);">
                    <div style="padding: 1rem; border-bottom: 1px solid hsl(var(--border));">
                        <h3 style="font-weight: 600; color: hsl(var(--primary));">Advanced Soil Analysis</h3>
                        <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                            Detailed soil parameters for precise recommendations
                        </p>
                    </div>
                    <div style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <label for="ph" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">pH Value (6-8)</label>
                                <input type="number" id="ph" step="0.1" min="0" max="14" value="7" class="input" />
                            </div>
                            <div>
                                <label for="nitrogen" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Nitrogen (N) %</label>
                                <input type="number" id="nitrogen" step="0.1" value="0" class="input" />
                            </div>
                            <div>
                                <label for="phosphorus" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Phosphorus (P) %</label>
                                <input type="number" id="phosphorus" step="0.1" value="0" class="input" />
                            </div>
                            <div>
                                <label for="potassium" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Potassium (K) %</label>
                                <input type="number" id="potassium" step="0.1" value="0" class="input" />
                            </div>
                            <div style="grid-column: span 2;">
                                <label for="organic" style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Organic Matter %</label>
                                <input type="number" id="organic" step="0.1" value="0" class="input" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="submit-form" class="btn btn-primary" style="width: 100%; padding: 1.5rem; font-size: 1.125rem; font-weight: 600;">
                    Start Farming Assistant →
                </button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden" style="display: flex; height: 100vh;">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Sidebar Header -->
                <div style="padding: 1.5rem; border-bottom: 1px solid hsl(var(--border)); background: hsl(var(--card));">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <img src="../assets/images/logo.png" alt="FasalMitra Logo" style="width: 2rem; height: 2rem; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-flex';">
                        <i class="fas fa-leaf" style="display: none; color: hsl(var(--primary)); font-size: 1.5rem;"></i>
                        <span style="color: hsl(var(--foreground)); font-weight: bold; font-size: 1.25rem;">FasalMitra</span>
                    </div>
                </div>

                <!-- Weather Section -->
                <div style="padding: 1.5rem; border-bottom: 1px solid hsl(var(--border));">
                    <h3 style="font-size: 1rem; font-weight: 600; color: hsl(var(--primary)); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="cloud-sun" style="height: 1.125rem; width: 1.125rem;"></i>
                        Weather
                    </h3>
                    <div style="text-align: center;">
                        <div id="sidebar-weather-temp" style="font-size: 1.5rem; font-weight: bold; color: hsl(var(--primary));">--°C</div>
                        <p id="sidebar-weather-desc" style="font-size: 0.75rem; color: hsl(var(--muted-foreground)); text-transform: capitalize; margin: 0.25rem 0 0 0;">Loading...</p>
                    </div>
                </div>

                <!-- Plant Disease Detection Section -->
                <div style="padding: 1.5rem; border-bottom: 1px solid hsl(var(--border));">
                    <h3 style="font-size: 0.9rem; font-weight: 600; color: hsl(var(--primary)); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="camera" style="height: 1rem; width: 1rem;"></i>
                        Plant Disease Detection
                    </h3>
                    <div id="sidebar-image-upload-area" style="border: 2px dashed hsl(var(--border)); border-radius: 0.5rem; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: hsl(var(--muted) / 0.3); margin-bottom: 1rem;" onclick="document.getElementById('sidebar-plant-image-input').click()">
                        <input type="file" id="sidebar-plant-image-input" accept="image/*" multiple style="display: none;" onchange="handleSidebarImageUpload(event)">
                        <i data-lucide="upload" style="height: 1.5rem; width: 1.5rem; color: hsl(var(--primary)); margin-bottom: 0.5rem;"></i>
                        <p style="color: hsl(var(--foreground)); font-weight: 500; margin: 0.25rem 0; font-size: 0.8rem;">Upload Plant Images</p>
                        <p style="color: hsl(var(--muted-foreground)); font-size: 0.7rem; margin: 0;">Disease detection & treatment</p>
                    </div>
                    <div id="sidebar-uploaded-images" style="display: none;">
                        <h4 style="font-size: 0.8rem; color: hsl(var(--primary)); margin-bottom: 0.5rem;">Recent Uploads:</h4>
                        <div id="sidebar-image-preview-container" style="display: flex; flex-wrap: wrap; gap: 0.25rem;"></div>
                    </div>
                </div>

                <!-- Quick Features -->
                <div style="padding: 1.5rem; border-bottom: 1px solid hsl(var(--border));">
                    <h3 style="font-size: 0.9rem; font-weight: 600; color: hsl(var(--primary)); margin-bottom: 1rem;">Quick Features</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="openCommunityForum()" class="btn btn-outline" style="width: 100%; font-size: 0.8rem; padding: 0.5rem;">
                            <i data-lucide="users" style="height: 0.9rem; width: 0.9rem; margin-right: 0.5rem;"></i>
                            Community Forum
                        </button>
                        <button onclick="openAlerts()" class="btn btn-outline" style="width: 100%; font-size: 0.8rem; padding: 0.5rem;">
                            <i data-lucide="bell" style="height: 0.9rem; width: 0.9rem; margin-right: 0.5rem;"></i>
                            Alerts & Notifications
                        </button>
                        <button onclick="openGovSchemes()" class="btn btn-outline" style="width: 100%; font-size: 0.8rem; padding: 0.5rem;">
                            <i data-lucide="landmark" style="height: 0.9rem; width: 0.9rem; margin-right: 0.5rem;"></i>
                            Govt Schemes
                        </button>
                        <button onclick="openInsurance()" class="btn btn-outline" style="width: 100%; font-size: 0.8rem; padding: 0.5rem;">
                            <i data-lucide="shield" style="height: 0.9rem; width: 0.9rem; margin-right: 0.5rem;"></i>
                            Insurance & Loans
                        </button>
                        <button onclick="openMarketAnalytics()" class="btn btn-outline" style="width: 100%; font-size: 0.8rem; padding: 0.5rem;">
                            <i data-lucide="trending-up" style="height: 0.9rem; width: 0.9rem; margin-right: 0.5rem;"></i>
                            Market Analytics
                        </button>
                        <button onclick="openSubsidyTracker()" class="btn btn-outline" style="width: 100%; font-size: 0.8rem; padding: 0.5rem;">
                            <i data-lucide="database" style="height: 0.9rem; width: 0.9rem; margin-right: 0.5rem;"></i>
                            Subsidy Tracker
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div style="padding: 1.5rem; margin-top: auto;">
                    <button id="back-button" class="btn btn-outline" style="width: 100%; margin-bottom: 1rem;">
                        <i data-lucide="arrow-left" style="height: 1rem; width: 1rem; margin-right: 0.5rem;"></i>
                        Back to Form
                    </button>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="main-content">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="message-square" style="height: 1.5rem; width: 1.5rem; color: hsl(var(--primary));"></i>
                        <div>
                            <h1 id="chat-welcome-title" style="font-size: 1.25rem; font-weight: 600; margin: 0; color: hsl(var(--foreground));">Welcome!</h1>
                            <p id="chat-user-info" style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin: 0;">Location • Acres • Mode</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button id="theme-toggle-main" onclick="toggleTheme()" class="btn btn-outline" style="border-radius: 8px; padding: 0.5rem;">
                            <i data-lucide="sun" style="height: 1.25rem; width: 1.25rem;"></i>
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages-main" style="flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; background: hsl(var(--background));"></div>

                <!-- Chat Input -->
                <div style="padding: 1rem; border-top: 1px solid hsl(var(--border)); background: hsl(var(--card));">
                    <div style="display: flex; gap: 0.5rem; align-items: center; max-width: 800px; margin: 0 auto;">
                        <!-- Image Upload Button -->
                        <button id="chat-image-btn" onclick="document.getElementById('chat-image-input').click()" class="btn btn-outline"
                                style="border-radius: 50%; width: 2.5rem; height: 2.5rem; padding: 0; display: flex; align-items: center; justify-content: center; margin-right: 0.25rem;"
                                title="Upload Plant Image">
                            <i data-lucide="image" style="height: 1rem; width: 1rem;"></i>
                        </button>
                        <input type="file" id="chat-image-input" accept="image/*" multiple style="display: none;" onchange="handleChatImageUpload(event)">
                        
                        <input type="text" id="chat-input-main" placeholder="Ask about crops, diseases, weather..." 
                               style="flex: 1; padding: 0.875rem 1rem; border-radius: 1.5rem; border: 1px solid hsl(var(--border)); 
                                      background-color: hsl(var(--background)); font-size: 0.9rem; outline: none; color: hsl(var(--foreground));"
                               onkeypress="if(event.key==='Enter') sendMessageMain()" />
                        
                        <!-- Voice Assistant Toggle -->
                        <button id="voice-assistant-btn" onclick="toggleVoiceAssistant()" class="btn btn-outline"
                                style="border-radius: 50%; width: 2.5rem; height: 2.5rem; padding: 0; display: flex; align-items: center; justify-content: center; margin-right: 0.25rem;"
                                title="Voice Assistant">
                            <i data-lucide="bot" style="height: 1rem; width: 1rem;"></i>
                        </button>
                        
                        <!-- Mic Button -->
                        <button id="mic-btn" onclick="toggleMic()" class="btn btn-outline"
                                style="border-radius: 50%; width: 2.5rem; height: 2.5rem; padding: 0; display: flex; align-items: center; justify-content: center; margin-right: 0.25rem;"
                                title="Voice Input">
                            <i data-lucide="mic" style="height: 1rem; width: 1rem;"></i>
                        </button>
                        
                        <!-- Clear Button -->
                        <button id="clear-btn" onclick="clearChat()" class="btn btn-outline"
                                style="border-radius: 50%; width: 2.5rem; height: 2.5rem; padding: 0; display: flex; align-items: center; justify-content: center; margin-right: 0.25rem;"
                                title="Clear Chat">
                            <i data-lucide="trash-2" style="height: 1rem; width: 1rem;"></i>
                        </button>
                        
                        <!-- Send Button -->
                        <button onclick="sendMessageMain()" class="btn btn-primary" 
                                style="border-radius: 50%; width: 2.5rem; height: 2.5rem; padding: 0; display: flex; align-items: center; justify-content: center;"
                                id="send-btn" title="Send Message">
                            <i data-lucide="send" style="height: 1rem; width: 1rem;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Plant Disease Detection Functions
        function handleSidebarImageUpload(event) {
            const files = Array.from(event.target.files);
            const sidebarImagePreviewContainer = document.getElementById('sidebar-image-preview-container');
            const sidebarUploadedImagesSection = document.getElementById('sidebar-uploaded-images');
            
            if (files.length === 0) return;
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            file: file,
                            dataUrl: e.target.result,
                            name: file.name
                        };
                        
                        // Create small image preview for sidebar
                        const imagePreview = document.createElement('div');
                        imagePreview.style.cssText = `
                            position: relative;
                            width: 40px;
                            height: 40px;
                            border-radius: 0.25rem;
                            overflow: hidden;
                            border: 1px solid hsl(var(--primary) / 0.3);
                        `;
                        
                        imagePreview.innerHTML = `
                            <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" alt="Plant image" title="${file.name}">
                        `;
                        
                        sidebarImagePreviewContainer.appendChild(imagePreview);
                        sidebarUploadedImagesSection.style.display = 'block';
                        
                        // Send to chat for analysis
                        sendImageToChat(imageData);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            showToast(`${files.length} plant image(s) uploaded for analysis`, 'success');
        }
        
        function sendImageToChat(imageData) {
            if (isLoading) return;
            
            // Add user message with image to chat
            chatMessages.push({
                role: 'user',
                content: `🌱 Analyzing plant image: ${imageData.name}`,
                timestamp: new Date(),
                hasImage: true,
                imageData: imageData
            });
            
            updateChatDisplayMain();
            
            isLoading = true;
            
            // Auto-analyze the image
            setTimeout(async () => {
                try {
                    const analysisResult = await getPlantDiseaseAnalysis(imageData);
                    
                    chatMessages.push({
                        role: 'assistant',
                        content: `**🔬 Plant Disease Analysis Results:**\n\n${analysisResult}`,
                        timestamp: new Date()
                    });
                    
                    updateChatDisplayMain();
                    
                    // Speak response if voice assistant is active
                    if (isVoiceAssistantActive) {
                        const cleanText = analysisResult.replace(/\*\*(.*?)\*\*/g, '$1').replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
                        speakText(cleanText);
                    }
                    
                    showToast('Plant analysis complete', 'success');
                    
                } catch (error) {
                    chatMessages.push({
                        role: 'assistant',
                        content: 'Sorry, I could not analyze the plant image. Please try uploading a clearer image or describe the plant issue in text.',
                        timestamp: new Date()
                    });
                    updateChatDisplayMain();
                    showToast('Plant analysis failed', 'error');
                }
                
                isLoading = false;
            }, 1000);
        }
        
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const uploadedImagesSection = document.getElementById('uploaded-images');
            
            if (files.length === 0) return;
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            file: file,
                            dataUrl: e.target.result,
                            name: file.name
                        };
                        
                        uploadedImages.push(imageData);
                        
                        // Create image preview
                        const imagePreview = document.createElement('div');
                        imagePreview.style.cssText = `
                            position: relative;
                            width: 80px;
                            height: 80px;
                            border-radius: 0.5rem;
                            overflow: hidden;
                            border: 2px solid hsl(var(--primary) / 0.3);
                        `;
                        
                        imagePreview.innerHTML = `
                            <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" alt="Uploaded plant image">
                            <button onclick="removeImage(${uploadedImages.length - 1})" 
                                    style="position: absolute; top: 2px; right: 2px; background: rgba(239, 68, 68, 0.9); 
                                           color: white; border: none; border-radius: 50%; width: 20px; height: 20px; 
                                           font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                ×
                            </button>
                        `;
                        
                        imagePreviewContainer.appendChild(imagePreview);
                        uploadedImagesSection.style.display = 'block';
                        
                        // Auto-analyze the image
                        analyzeImage(imageData);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            showToast(`${files.length} image(s) uploaded for analysis`, 'success');
        }
        
        function handleChatImageUpload(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            file: file,
                            dataUrl: e.target.result,
                            name: file.name
                        };
                        
                        chatImages.push(imageData);
                        
                        // Auto-send message with image
                        sendImageMessage(imageData);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            showToast('Image uploaded to chat', 'success');
        }
        
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }
        
        function updateImagePreview() {
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const uploadedImagesSection = document.getElementById('uploaded-images');
            
            imagePreviewContainer.innerHTML = '';
            
            if (uploadedImages.length === 0) {
                uploadedImagesSection.style.display = 'none';
                return;
            }
            
            uploadedImages.forEach((imageData, index) => {
                const imagePreview = document.createElement('div');
                imagePreview.style.cssText = `
                    position: relative;
                    width: 80px;
                    height: 80px;
                    border-radius: 0.5rem;
                    overflow: hidden;
                    border: 2px solid hsl(var(--primary) / 0.3);
                `;
                
                imagePreview.innerHTML = `
                    <img src="${imageData.dataUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="Uploaded plant image">
                    <button onclick="removeImage(${index})" 
                            style="position: absolute; top: 2px; right: 2px; background: rgba(239, 68, 68, 0.9); 
                                   color: white; border: none; border-radius: 50%; width: 20px; height: 20px; 
                                   font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        ×
                    </button>
                `;
                
                imagePreviewContainer.appendChild(imagePreview);
            });
        }
        
        async function analyzeImage(imageData) {
            try {
                const analysisResult = await getPlantDiseaseAnalysis(imageData);
                
                // Add analysis result to chat
                chatMessages.push({
                    role: 'assistant',
                    content: `**Plant Disease Analysis for ${imageData.name}:**\n\n${analysisResult}`,
                    timestamp: new Date(),
                    hasImage: true,
                    imageData: imageData
                });
                
                updateChatDisplayMain();
                showToast('Image analysis complete', 'success');
                
            } catch (error) {
                console.error('Image analysis failed:', error);
                showToast('Image analysis failed', 'error');
            }
        }
        
        async function sendImageMessage(imageData) {
            if (isLoading) return;
            
            // Add user message with image
            chatMessages.push({
                role: 'user',
                content: `📸 Uploaded image: ${imageData.name}`,
                timestamp: new Date(),
                hasImage: true,
                imageData: imageData
            });
            
            updateChatDisplayMain();
            
            isLoading = true;
            
            try {
                const analysisResult = await getPlantDiseaseAnalysis(imageData);
                
                chatMessages.push({
                    role: 'assistant',
                    content: analysisResult,
                    timestamp: new Date()
                });
                
                updateChatDisplayMain();
                
                // Speak response if voice assistant is active
                if (isVoiceAssistantActive) {
                    const cleanText = analysisResult.replace(/\*\*(.*?)\*\*/g, '$1').replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
                    speakText(cleanText);
                }
                
            } catch (error) {
                chatMessages.push({
                    role: 'assistant',
                    content: 'Sorry, I could not analyze the image. Please try again or describe the plant issue in text.',
                    timestamp: new Date()
                });
                updateChatDisplayMain();
            }
            
            isLoading = false;
        }
        
        async function getPlantDiseaseAnalysis(imageData) {
            const languageInstruction = userData?.language !== 'en' ? `Please respond in ${LANGUAGES[userData.language]}. ` : '';
            
            // Simulate image analysis (in real implementation, you would use an image recognition API)
            const diseaseAnalysisPrompt = `
                ${languageInstruction}You are an expert plant pathologist and agricultural advisor. Analyze this plant image and provide:
                
                1. **Plant Identification**: What type of plant/crop is this?
                2. **Disease/Issue Detection**: Any visible diseases, pests, deficiencies, or problems
                3. **Severity Assessment**: How serious is the condition?
                4. **Treatment Recommendations**: Specific steps to treat the issue
                5. **Prevention Tips**: How to prevent this in the future
                6. **Timeline**: When to expect recovery
                
                Image filename: ${imageData.name}
                
                Based on common plant diseases and the image analysis, provide detailed recommendations. 
                If no issues are visible, confirm the plant appears healthy and provide general care tips.
                
                Use ** for bold text for important points. Keep the analysis practical and actionable for farmers.
            `;
            
            return await getCropAdvice(diseaseAnalysisPrompt, userData?.language || 'en');
        }
        function updatePlaceholder() {
            const unitSelect = document.getElementById('landunit');
            const areaInput = document.getElementById('landarea');
            const selectedUnit = unitSelect.value;
            
            const unitExamples = {
                'acres': 'e.g., 5.5 acres',
                'hectares': 'e.g., 2.5 hectares', 
                'sq_feet': 'e.g., 100000 sq ft',
                'sq_meters': 'e.g., 10000 sq m',
                'bigha': 'e.g., 8 bigha',
                'kanal': 'e.g., 40 kanal',
                'marla': 'e.g., 800 marla'
            };
            
            areaInput.placeholder = unitExamples[selectedUnit] || 'Enter amount';
            showPreview();
        }
        
        function showPreview() {
            const areaInput = document.getElementById('landarea');
            const unitSelect = document.getElementById('landunit');
            const preview = document.getElementById('area-preview');
            const previewText = document.getElementById('preview-text');
            
            const amount = parseFloat(areaInput.value);
            const unit = unitSelect.options[unitSelect.selectedIndex].text;
            
            if (amount && amount > 0) {
                previewText.textContent = `${amount} ${unit}`;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // Global variables
        let userData = null;
        let chatMessages = [];
        let weatherData = null;
        let isLoading = false;
        let currentMode = 'simple';
        let selectedLanguage = 'en';
        let locationSearchTimeout = null; // For debouncing location search
        let uploadedImages = []; // Store uploaded images
        let chatImages = []; // Store images for chat
        
        // Voice and Chat functionality
        let isRecording = false;
        let isVoiceAssistantActive = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;
        let weatherRetryInterval = null;
        
        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
        }
        
        // Clear chat function
        function clearChat() {
            if (confirm('Clear all chat messages?')) {
                chatMessages = [];
                updateChatDisplayMain();
                showToast('Chat cleared', 'success');
            }
        }
        
        // Toggle microphone
        function toggleMic() {
            if (!recognition) {
                showToast('Speech recognition not supported', 'error');
                return;
            }
            
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        // Start recording
        function startRecording() {
            if (!recognition) return;
            
            const micBtn = document.getElementById('mic-btn');
            micBtn.style.backgroundColor = 'hsl(var(--destructive))';
            micBtn.style.color = 'white';
            
            recognition.onstart = function() {
                isRecording = true;
                showToast('Listening...', 'info');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chat-input-main').value = transcript;
                
                if (isVoiceAssistantActive) {
                    // Auto-send in voice assistant mode
                    setTimeout(sendMessageMain, 500);
                }
            };
            
            recognition.onerror = function(event) {
                showToast('Speech recognition error: ' + event.error, 'error');
                stopRecording();
            };
            
            recognition.onend = function() {
                stopRecording();
            };
            
            recognition.start();
        }
        
        // Stop recording
        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            const micBtn = document.getElementById('mic-btn');
            micBtn.style.backgroundColor = '';
            micBtn.style.color = '';
        }
        
        // Toggle voice assistant
        function toggleVoiceAssistant() {
            isVoiceAssistantActive = !isVoiceAssistantActive;
            const voiceBtn = document.getElementById('voice-assistant-btn');
            
            if (isVoiceAssistantActive) {
                voiceBtn.style.backgroundColor = 'hsl(var(--primary))';
                voiceBtn.style.color = 'white';
                showToast('Voice Assistant activated - Speak and I will respond!', 'success');
                
                // Auto-start listening
                setTimeout(startRecording, 1000);
            } else {
                voiceBtn.style.backgroundColor = '';
                voiceBtn.style.color = '';
                showToast('Voice Assistant deactivated', 'info');
                stopRecording();
            }
        }
        
        // Speak text function
        function speakText(text) {
            if (!speechSynthesis) return;
            
            // Stop any current speech
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            
            utterance.onend = function() {
                if (isVoiceAssistantActive) {
                    // Auto-start listening again
                    setTimeout(startRecording, 1000);
                }
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // Enhanced weather loading with retry
        async function loadWeatherWithRetry() {
            if (!userData?.location) return;
            
            const maxRetries = 10;
            let retryCount = 0;
            
            const tryLoadWeather = async () => {
                try {
                    weatherData = await getWeatherData(userData.location.lat, userData.location.lon);
                    document.getElementById('sidebar-weather-temp').textContent = `${Math.round(weatherData.main.temp)}°C`;
                    document.getElementById('sidebar-weather-desc').textContent = weatherData.weather[0].description;
                    
                    // Clear retry interval on success
                    if (weatherRetryInterval) {
                        clearInterval(weatherRetryInterval);
                        weatherRetryInterval = null;
                    }
                    
                    showToast('Weather data loaded', 'success');
                } catch (error) {
                    retryCount++;
                    
                    if (retryCount >= maxRetries) {
                        document.getElementById('sidebar-weather-temp').textContent = 'N/A';
                        document.getElementById('sidebar-weather-desc').textContent = 'Weather unavailable';
                        
                        if (weatherRetryInterval) {
                            clearInterval(weatherRetryInterval);
                            weatherRetryInterval = null;
                        }
                    }
                    // Keep showing "Loading..." while retrying
                }
            };
            
            // Initial attempt
            await tryLoadWeather();
            
            // Set up retry interval if first attempt failed
            if (!weatherData && retryCount < maxRetries) {
                weatherRetryInterval = setInterval(tryLoadWeather, 3000); // Retry every 3 seconds
            }
        }

        // Language names mapping
        const LANGUAGES = {
            en: 'English',
            hi: 'Hindi',
            pa: 'Punjabi', 
            mr: 'Marathi',
            kn: 'Kannada',
            ta: 'Tamil',
            te: 'Telugu',
            gu: 'Gujarati'
        };

        // API Keys
        const GEMINI_API_KEY = 'AIzaSyCLc_LRc2giTjUkG0p7kez2nAKN4JOttZ8';
        const WEATHER_API_KEY = 'f27b269d54e4fa1e72993364a80fa8bd';

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            if (type === 'success') {
                toast.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                toast.style.backgroundColor = '#ef4444';
            } else {
                toast.style.backgroundColor = '#3b82f6';
            }
            
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Location API with enhanced debugging
        async function getLocationFromZip(zipCode) {
            console.log('Searching for ZIP code:', zipCode);
            try {
                // Try the primary geocoding API
                const apiUrl = `https://api.openweathermap.org/geo/1.0/zip?zip=${zipCode},IN&appid=${WEATHER_API_KEY}`;
                console.log('API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Primary API Error:', errorText);
                    
                    // Try alternative direct city search if ZIP fails
                    return await getLocationFromZipAlternative(zipCode);
                }
                
                const data = await response.json();
                console.log('API Response data:', data);
                
                if (!data.lat || !data.lon || !data.name) {
                    throw new Error('Invalid location data received');
                }
                
                return { lat: data.lat, lon: data.lon, city: data.name };
            } catch (error) {
                console.error('Location lookup error:', error);
                
                // Try alternative API or fallback method
                try {
                    return await getLocationFromZipAlternative(zipCode);
                } catch (alternativeError) {
                    return await getLocationFromZipFallback(zipCode);
                }
            }
        }
        
        // Alternative API using direct search
        async function getLocationFromZipAlternative(zipCode) {
            console.log('Trying alternative API for ZIP:', zipCode);
            try {
                // Use the direct city search API which often works better for Indian PIN codes
                const response = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${zipCode},IN&limit=5&appid=${WEATHER_API_KEY}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Alternative API Error:', errorText);
                    throw new Error('Alternative API failed');
                }
                
                const data = await response.json();
                console.log('Alternative API Response data:', data);
                
                if (data && data.length > 0) {
                    const location = data[0];
                    return { lat: location.lat, lon: location.lon, city: location.name };
                }
                
                throw new Error('No location found in alternative API');
            } catch (error) {
                console.error('Alternative API error:', error);
                throw error;
            }
        }
        
        // Fallback location detection using alternative method
        async function getLocationFromZipFallback(zipCode) {
            console.log('Trying fallback method for ZIP:', zipCode);
            
            // Expanded Indian PIN codes mapping for testing
            const commonPinCodes = {
                '110001': { lat: 28.6139, lon: 77.2090, city: 'New Delhi' },
                '400001': { lat: 18.9322, lon: 72.8264, city: 'Mumbai' },
                '560001': { lat: 12.9716, lon: 77.5946, city: 'Bangalore' },
                '600001': { lat: 13.0827, lon: 80.2707, city: 'Chennai' },
                '700001': { lat: 22.5726, lon: 88.3639, city: 'Kolkata' },
                '500001': { lat: 17.3850, lon: 78.4867, city: 'Hyderabad' },
                '411001': { lat: 18.5204, lon: 73.8567, city: 'Pune' },
                '302001': { lat: 26.9124, lon: 75.7873, city: 'Jaipur' },
                '380001': { lat: 23.0225, lon: 72.5714, city: 'Ahmedabad' },
                '800001': { lat: 25.5941, lon: 85.1376, city: 'Patna' },
                // Maharashtra PIN codes
                '416115': { lat: 16.7050, lon: 74.2433, city: 'Kolhapur' },
                '413401': { lat: 18.1024, lon: 76.8124, city: 'Solapur' },
                '414001': { lat: 19.8762, lon: 75.3433, city: 'Ahmednagar' },
                '422001': { lat: 19.9975, lon: 73.7898, city: 'Nashik' },
                '431001': { lat: 19.1383, lon: 76.7094, city: 'Aurangabad' },
                // Karnataka PIN codes
                '560002': { lat: 12.9716, lon: 77.5946, city: 'Bangalore' },
                '580001': { lat: 15.3647, lon: 75.1240, city: 'Hubli' },
                '585101': { lat: 17.3297, lon: 76.8343, city: 'Gulbarga' },
                // Tamil Nadu PIN codes
                '600002': { lat: 13.0827, lon: 80.2707, city: 'Chennai' },
                '641001': { lat: 11.0168, lon: 76.9558, city: 'Coimbatore' },
                '620001': { lat: 10.7905, lon: 78.7047, city: 'Trichy' }
            };
            
            if (commonPinCodes[zipCode]) {
                console.log('Found PIN code in fallback database');
                return commonPinCodes[zipCode];
            }
            
            throw new Error('PIN code not found in fallback database');
        }

        // Weather API with enhanced debugging
        async function getWeatherData(lat, lon) {
            console.log('Fetching weather data for coordinates:', lat, lon);
            try {
                const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric`;
                console.log('Weather API URL:', weatherUrl);
                
                const response = await fetch(weatherUrl);
                console.log('Weather API Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Weather API Error:', errorText);
                    throw new Error(`Weather fetch failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Weather API Response data:', data);
                
                return data;
            } catch (error) {
                console.error('Weather data error:', error);
                throw new Error('Weather data unavailable');
            }
        }
        
        // Direct weather check function for city or ZIP (updated)
        async function checkWeather(query) {
            const API_KEY = 'f27b269d54e4fa1e72993364a80fa8bd';
            console.log('Checking weather for:', query);
            
            try {
                let url;
                // Check if it's a ZIP code (contains only digits) or city name
                if(/^\d+$/.test(query)){ 
                    // If only digits → ZIP code
                    // Try with country code for better results
                    url = `https://api.openweathermap.org/data/2.5/weather?zip=${query},IN&appid=${API_KEY}&units=metric`;
                    console.log('Using ZIP API for:', query);
                } else {
                    // Otherwise city name
                    url = `https://api.openweathermap.org/data/2.5/weather?q=${query},IN&appid=${API_KEY}&units=metric`;
                    console.log('Using City API for:', query);
                }
                
                console.log('Weather API URL:', url);
                const response = await fetch(url);
                
                console.log('Response status:', response.status);
                
                if(!response.ok) {
                    // If ZIP code fails, try as city name
                    if(/^\d+$/.test(query)) {
                        console.log('ZIP failed, trying as city name...');
                        const fallbackUrl = `https://api.openweathermap.org/data/2.5/weather?q=${query},IN&appid=${API_KEY}&units=metric`;
                        const fallbackResponse = await fetch(fallbackUrl);
                        
                        if(!fallbackResponse.ok) {
                            throw new Error(`HTTP ${response.status}: Location not found for PIN code ${query}`);
                        }
                        
                        const fallbackData = await fallbackResponse.json();
                        return {
                            name: fallbackData.name,
                            temp: fallbackData.main.temp,
                            description: fallbackData.weather[0].description,
                            humidity: fallbackData.main.humidity,
                            windSpeed: fallbackData.wind.speed,
                            icon: fallbackData.weather[0].icon,
                            coord: fallbackData.coord
                        };
                    }
                    
                    throw new Error(`HTTP ${response.status}: Location not found`);
                }
                
                const data = await response.json();
                console.log('Weather API Response:', data);
                
                return {
                    name: data.name,
                    temp: data.main.temp,
                    description: data.weather[0].description,
                    humidity: data.main.humidity,
                    windSpeed: data.wind.speed,
                    icon: data.weather[0].icon,
                    coord: data.coord
                };
            } catch (error) {
                console.error('Weather lookup error:', error);
                throw error;
            }
        }

        // AI Chat API
        async function getCropAdvice(prompt, language = 'en') {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `You are an expert agricultural advisor. ${prompt}` }] }]
                    })
                });
                
                if (!response.ok) throw new Error('AI request failed');
                const data = await response.json();
                return data.candidates[0]?.content?.parts[0]?.text || 'Sorry, I could not generate advice at this time.';
            } catch (error) {
                return 'I apologize, but I cannot provide advice right now. Please try again later.';
            }
        }

        // Mode toggle functionality
        document.getElementById('mode-toggle').addEventListener('change', (e) => {
            const isAdvanced = e.target.checked;
            currentMode = isAdvanced ? 'advanced' : 'simple';
            
            const modeLabel = document.getElementById('mode-label');
            const modeDescription = document.getElementById('mode-description');
            const advancedFields = document.getElementById('advanced-fields');
            const toggleBg = document.getElementById('toggle-bg');
            const toggleDot = document.getElementById('toggle-dot');
            
            if (isAdvanced) {
                modeLabel.textContent = 'Advanced Mode';
                modeDescription.textContent = 'Detailed analysis with soil chemistry data';
                advancedFields.classList.remove('hidden');
                toggleBg.style.backgroundColor = 'hsl(var(--primary))';
                toggleDot.style.transform = 'translateX(1.25rem)';
            } else {
                modeLabel.textContent = 'Simple Mode';
                modeDescription.textContent = 'Basic farming guidance for all farmers';
                advancedFields.classList.add('hidden');
                toggleBg.style.backgroundColor = '#d1d5db';
                toggleDot.style.transform = 'translateX(0)';
            }
        });

        // Language selection handling
        document.getElementById('language-select').addEventListener('change', (e) => {
            selectedLanguage = e.target.value;
        });

        // Simple and reliable location lookup function
        async function findLocation(input) {
            console.log('Finding location for:', input);
            
            // Step 1: Check fallback database first for PIN codes (PRIORITY)
            if(/^\d{6}$/.test(input)) {
                console.log('6-digit PIN detected, checking fallback database first...');
                
                const fallbackData = {
                    '416115': { lat: 16.7050, lon: 74.2433, city: 'Kolhapur' },
                    '110001': { lat: 28.6139, lon: 77.2090, city: 'New Delhi' },
                    '400001': { lat: 18.9322, lon: 72.8264, city: 'Mumbai' },
                    '560001': { lat: 12.9716, lon: 77.5946, city: 'Bangalore' },
                    '600001': { lat: 13.0827, lon: 80.2707, city: 'Chennai' },
                    '413401': { lat: 18.1024, lon: 76.8124, city: 'Solapur' },
                    '411001': { lat: 18.5204, lon: 73.8567, city: 'Pune' },
                    '422001': { lat: 19.9975, lon: 73.7898, city: 'Nashik' },
                    '414001': { lat: 19.8762, lon: 75.3433, city: 'Ahmednagar' },
                    '431001': { lat: 19.1383, lon: 76.7094, city: 'Aurangabad' }
                };
                
                if (fallbackData[input]) {
                    console.log('✅ FOUND in fallback database:', fallbackData[input]);
                    return fallbackData[input];
                }
                
                console.log('❌ PIN code not in fallback database, trying API...');
            }
            
            // Step 2: Try weather API only if not found in database
            try {
                console.log('Trying weather API for:', input);
                const weatherData = await checkWeather(input);
                console.log('✅ Weather API success:', weatherData);
                return {
                    lat: weatherData.coord.lat,
                    lon: weatherData.coord.lon,
                    city: weatherData.name
                };
            } catch (error) {
                console.log('❌ Weather API failed:', error.message);
                throw new Error(`Location "${input}" not found`);
            }
        }
        
        // Location input event listener with debounce
        document.getElementById('location-input').addEventListener('input', async (e) => {
            const locationInput = e.target.value.trim();
            const locationDisplay = document.getElementById('location-display');
            const locationText = document.getElementById('location-text');
            
            // Clear any existing timeout
            if (locationSearchTimeout) {
                clearTimeout(locationSearchTimeout);
                locationSearchTimeout = null;
            }
            
            // Reset display if input is cleared
            if (locationInput.length === 0) {
                locationDisplay.classList.add('hidden');
                return;
            }
            
            // Don't show anything while user is still typing (less than 3 characters)
            if (locationInput.length < 3) {
                locationDisplay.classList.add('hidden');
                return;
            }
            
            // Set a timeout to wait for user to finish typing (2.5 seconds)
            locationSearchTimeout = setTimeout(async () => {
                try {
                    // Show searching state
                    locationText.textContent = '🔄 Searching location...';
                    locationText.style.color = '#3b82f6';
                    locationDisplay.classList.remove('hidden');
                    
                    console.log('Looking up location:', locationInput);
                    const locationData = await findLocation(locationInput);
                    
                    // Success - location found
                    locationText.textContent = `📍 ${locationData.city}`;
                    locationText.style.color = 'hsl(var(--primary))';
                    locationDisplay.classList.remove('hidden');
                    
                    userData = userData || {};
                    userData = { ...userData, location: { ...locationData, input: locationInput } };
                    showToast(`Location found: ${locationData.city}`, 'success');
                    
                    console.log('Location found successfully:', locationData);
                    
                } catch (error) {
                    console.error('Location lookup failed:', error);
                    
                    // Error - location not found
                    locationText.textContent = '❌ Location not found';
                    locationText.style.color = '#ef4444';
                    locationDisplay.classList.remove('hidden');
                    
                    showToast(error.message, 'error');
                    
                    // Clear location data
                    if (userData && userData.location) {
                        delete userData.location;
                    }
                }
            }, 2500); // Wait 2.5 seconds after user stops typing
        });
        
        // Test location button functionality (updated with debugging)
        document.getElementById('test-location-btn').addEventListener('click', () => {
            const testLocations = ['Mumbai', 'Delhi', '416115', '110001', '400001', 'Bangalore', 'Chennai', '413401', '422001'];
            const randomLocation = testLocations[Math.floor(Math.random() * testLocations.length)];
            
            const locationInput = document.getElementById('location-input');
            locationInput.value = randomLocation;
            
            console.log('Test button clicked, testing with:', randomLocation);
            console.log('userData before test:', userData);
            
            // Trigger the input event to test the lookup
            const event = new Event('input', { bubbles: true });
            locationInput.dispatchEvent(event);
            
            showToast(`Testing with: ${randomLocation}`, 'info');
        });

        // Form submission
        document.getElementById('submit-form').addEventListener('click', async () => {
            const nickname = document.getElementById('nickname').value;
            const landArea = document.getElementById('landarea').value;
            const landUnit = document.getElementById('landunit').value;
            const soilType = document.getElementById('soiltype').value;
            
            if (!nickname || !landArea || !soilType || !userData?.location?.city) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            if (parseFloat(landArea) <= 0) {
                showToast('Land area must be greater than 0', 'error');
                return;
            }
            
            // Convert land area to acres for standardization
            let landAreaInAcres = parseFloat(landArea);
            switch(landUnit) {
                case 'hectares':
                    landAreaInAcres = landArea * 2.471;
                    break;
                case 'sq_feet':
                    landAreaInAcres = landArea / 43560;
                    break;
                case 'sq_meters':
                    landAreaInAcres = landArea / 4047;
                    break;
                case 'bigha':
                    landAreaInAcres = landArea * 0.619;
                    break;
                case 'kanal':
                    landAreaInAcres = landArea * 0.125;
                    break;
                case 'marla':
                    landAreaInAcres = landArea * 0.00625;
                    break;
                default: // acres
                    landAreaInAcres = parseFloat(landArea);
            }
            
            // Collect advanced data if in advanced mode
            let advancedData = null;
            if (currentMode === 'advanced') {
                advancedData = {
                    phValue: parseFloat(document.getElementById('ph').value) || 7,
                    nitrogen: parseFloat(document.getElementById('nitrogen').value) || 0,
                    phosphorus: parseFloat(document.getElementById('phosphorus').value) || 0,
                    potassium: parseFloat(document.getElementById('potassium').value) || 0,
                    organicMatter: parseFloat(document.getElementById('organic').value) || 0
                };
            }
            
            userData = {
                nickname,
                landArea: landAreaInAcres,
                landAreaOriginal: parseFloat(landArea),
                landUnit: landUnit,
                soilType,
                mode: currentMode,
                language: selectedLanguage,
                location: userData.location,
                advancedData
            };
            
            showDashboard();
        });

        // Show dashboard
        async function showDashboard() {
            document.getElementById('form-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            
            // Update header
            document.getElementById('chat-welcome-title').textContent = `Welcome, ${userData.nickname}!`;
            document.getElementById('chat-user-info').textContent = `${userData.location.city} • ${userData.landAreaOriginal} ${userData.landUnit} • ${userData.mode} mode`;
            
            // Load weather data with retry
            loadWeatherWithRetry();
            
            // Initialize chat with greeting immediately
            await initializeChatMain();
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const isCurrentlyDark = body.classList.contains('dark');
            
            if (isCurrentlyDark) {
                body.classList.remove('dark');
                const themeToggle = document.querySelector('#theme-toggle i');
                const themeToggleMain = document.querySelector('#theme-toggle-main i');
                if (themeToggle) themeToggle.setAttribute('data-lucide', 'sun');
                if (themeToggleMain) themeToggleMain.setAttribute('data-lucide', 'sun');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                const themeToggle = document.querySelector('#theme-toggle i');
                const themeToggleMain = document.querySelector('#theme-toggle-main i');
                if (themeToggle) themeToggle.setAttribute('data-lucide', 'moon');
                if (themeToggleMain) themeToggleMain.setAttribute('data-lucide', 'moon');
                localStorage.setItem('theme', 'dark');
            }
            
            // Reinitialize lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            
            if (savedTheme === 'dark') {
                body.classList.add('dark');
                const themeToggle = document.querySelector('#theme-toggle i');
                const themeToggleMain = document.querySelector('#theme-toggle-main i');
                if (themeToggle) themeToggle.setAttribute('data-lucide', 'moon');
                if (themeToggleMain) themeToggleMain.setAttribute('data-lucide', 'moon');
            } else {
                body.classList.remove('dark');
                const themeToggle = document.querySelector('#theme-toggle i');
                const themeToggleMain = document.querySelector('#theme-toggle-main i');
                if (themeToggle) themeToggle.setAttribute('data-lucide', 'sun');
                if (themeToggleMain) themeToggleMain.setAttribute('data-lucide', 'sun');
            }
            
            // Recreate lucide icons after setting attributes
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        }
        
        // Initialize main chat
        async function initializeChatMain() {
            const languageInstruction = userData.language !== 'en' ? `Please respond in ${LANGUAGES[userData.language]}. ` : '';
            
            const greeting = await getCropAdvice(`${languageInstruction}You are FasalMitra, an expert agricultural AI assistant. Give a brief welcome message for farmer ${userData.nickname} in ${userData.location.city}. Land area: ${userData.landArea} acres, Soil: ${userData.soilType}, Mode: ${userData.mode}. ${userData.mode === 'advanced' && userData.advancedData ? `Advanced soil data - pH: ${userData.advancedData.phValue}, N-P-K: ${userData.advancedData.nitrogen}-${userData.advancedData.phosphorus}-${userData.advancedData.potassium}, Organic Matter: ${userData.advancedData.organicMatter}%. ` : ''}Give a personalized welcome and ask how you can help today with farming, crops, diseases, or agricultural advice. Keep it brief and friendly.`, userData.language);
            
            chatMessages = [{
                role: 'assistant',
                content: greeting,
                timestamp: new Date()
            }];
            
            updateChatDisplayMain();
        }
        
        // Update main chat display
        function updateChatDisplayMain() {
            const chatContainer = document.getElementById('chat-messages-main');
            chatContainer.innerHTML = '';
            
            chatMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = message.role === 'user' ? 'message-user' : 'message-assistant';
                
                let imageHtml = '';
                if (message.hasImage && message.imageData) {
                    imageHtml = `
                        <div style="margin-bottom: 0.5rem;">
                            <img src="${message.imageData.dataUrl}" 
                                 style="max-width: 200px; max-height: 200px; border-radius: 0.5rem; border: 1px solid hsl(var(--border));" 
                                 alt="Plant image" onclick="openImageModal('${message.imageData.dataUrl}')" 
                                 title="Click to view full size">
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    ${imageHtml}
                    <div style="font-size: 0.875rem; line-height: 1.5; word-break: break-word;">${formatMessage(message.content)}</div>
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">${message.timestamp.toLocaleTimeString()}</div>
                `;
                
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Send message in main chat
        async function sendMessageMain() {
            const input = document.getElementById('chat-input-main');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            chatMessages.push({
                role: 'user',
                content: message,
                timestamp: new Date()
            });
            
            input.value = '';
            updateChatDisplayMain();
            
            isLoading = true;
            
            const languageInstruction = userData.language !== 'en' ? `Please respond in ${LANGUAGES[userData.language]}. ` : '';
            
            const context = `
                ${languageInstruction}You are FasalMitra, an expert agricultural AI assistant. Only answer questions related to farming, agriculture, crops, soil, weather, diseases, pests, fertilizers, and agricultural practices. If asked about non-agricultural topics, politely redirect to agricultural matters.
                
                Farmer Profile:
                - Name: ${userData.nickname}
                - Location: ${userData.location.city}
                - Land Area: ${userData.landArea} acres
                - Soil Type: ${userData.soilType}
                - Mode: ${userData.mode}
                ${userData.mode === 'advanced' && userData.advancedData ? `
                - pH Level: ${userData.advancedData.phValue}
                - N-P-K Values: ${userData.advancedData.nitrogen}-${userData.advancedData.phosphorus}-${userData.advancedData.potassium}
                - Organic Matter: ${userData.advancedData.organicMatter}%` : ''}
                
                Current Weather: ${weatherData ? `${weatherData.main.temp}°C, ${weatherData.weather[0].description}` : 'Not available'}
                
                Current Question: ${message}
                
                Provide helpful, accurate agricultural advice in simple language appropriate for ${userData.mode} mode. Use ** for bold text when emphasizing important points. ${userData.mode === 'advanced' ? 'Include technical details and specific recommendations based on soil chemistry data.' : 'Keep explanations simple and practical for general farming.'}
            `;
            
            const aiResponse = await getCropAdvice(context, userData.language);
            
            chatMessages.push({
                role: 'assistant',
                content: aiResponse,
                timestamp: new Date()
            });
            
            isLoading = false;
            updateChatDisplayMain();
        }

        // Back button
        document.getElementById('back-button').addEventListener('click', () => {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('form-view').classList.remove('hidden');
        });
        
        // Stub functions for sidebar buttons
        function openCommunityForum() {
            showToast('Community Forum feature coming soon!', 'info');
        }
        
        function openAlerts() {
            showToast('Alerts & Notifications feature coming soon!', 'info');
        }
        
        function openGovSchemes() {
            showToast('Government Schemes feature coming soon!', 'info');
        }
        
        function openInsurance() {
            showToast('Insurance & Loans feature coming soon!', 'info');
        }
        
        function openMarketAnalytics() {
            showToast('Market Analytics feature coming soon!', 'info');
        }
        
        function openSubsidyTracker() {
            showToast('Subsidy Tracker feature coming soon!', 'info');
        }

        async function initializeChat() {
            const languageInstruction = userData.language !== 'en' ? `Please respond in ${LANGUAGES[userData.language]}. ` : '';
            
            const greeting = await getCropAdvice(`${languageInstruction}You are FasalMitra, an expert agricultural AI assistant. Give a welcome message for farmer ${userData.nickname} in ${userData.location.city}. Land area: ${userData.landArea} acres, Soil: ${userData.soilType}, Mode: ${userData.mode}. ${userData.mode === 'advanced' && userData.advancedData ? `Advanced soil data - pH: ${userData.advancedData.phValue}, N-P-K: ${userData.advancedData.nitrogen}-${userData.advancedData.phosphorus}-${userData.advancedData.potassium}, Organic Matter: ${userData.advancedData.organicMatter}%. ` : ''}Give a personalized welcome and ask how you can help today with farming, crops, diseases, or agricultural advice.`, userData.language);
            
            chatMessages = [{
                role: 'assistant',
                content: greeting,
                timestamp: new Date()
            }];
            
            updateChatDisplay();
        }

        function updateChatDisplay() {
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML = '';
            
            chatMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `display: flex; ${message.role === 'user' ? 'justify-content: flex-end' : 'justify-content: flex-start'};`;
                
                const messageContent = document.createElement('div');
                messageContent.style.cssText = `
                    max-width: 85%;
                    padding: 0.75rem;
                    border-radius: 0.5rem;
                    ${message.role === 'user' 
                        ? 'background-color: hsl(var(--primary)); color: hsl(var(--primary-foreground));' 
                        : 'background-color: hsl(var(--muted)); color: hsl(var(--foreground));'
                    }
                `;
                
                messageContent.innerHTML = `
                    <div style="font-size: 0.875rem; line-height: 1.5; word-break: break-word;">${formatMessage(message.content)}</div>
                    <p style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">${message.timestamp.toLocaleTimeString()}</p>
                `;
                
                messageDiv.appendChild(messageContent);
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function formatMessage(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            chatMessages.push({
                role: 'user',
                content: message,
                timestamp: new Date()
            });
            
            input.value = '';
            updateChatDisplay();
            
            isLoading = true;
            
            const languageInstruction = userData.language !== 'en' ? `Please respond in ${LANGUAGES[userData.language]}. ` : '';
            
            const context = `
                ${languageInstruction}You are FasalMitra, an expert agricultural AI assistant. Only answer questions related to farming, agriculture, crops, soil, weather, diseases, pests, fertilizers, and agricultural practices. If asked about non-agricultural topics, politely redirect to agricultural matters.
                
                Farmer Profile:
                - Name: ${userData.nickname}
                - Location: ${userData.location.city}
                - Land Area: ${userData.landArea} acres
                - Soil Type: ${userData.soilType}
                - Mode: ${userData.mode}
                ${userData.mode === 'advanced' && userData.advancedData ? `
                - pH Level: ${userData.advancedData.phValue}
                - N-P-K Values: ${userData.advancedData.nitrogen}-${userData.advancedData.phosphorus}-${userData.advancedData.potassium}
                - Organic Matter: ${userData.advancedData.organicMatter}%` : ''}
                
                Current Weather: ${weatherData ? `${weatherData.main.temp}°C, ${weatherData.weather[0].description}` : 'Not available'}
                
                Current Question: ${message}
                
                Provide helpful, accurate agricultural advice in simple language appropriate for ${userData.mode} mode. Use ** for bold text when emphasizing important points. ${userData.mode === 'advanced' ? 'Include technical details and specific recommendations based on soil chemistry data.' : 'Keep explanations simple and practical for general farming.'}
            `;
            
            const aiResponse = await getCropAdvice(context, userData.language);
            
            chatMessages.push({
                role: 'assistant',
                content: aiResponse,
                timestamp: new Date()
            });
            
            isLoading = false;
            updateChatDisplay();
        }

        async function sendMessageMain() {
            const input = document.getElementById('chat-input-main');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            chatMessages.push({
                role: 'user',
                content: message,
                timestamp: new Date()
            });
            
            input.value = '';
            updateChatDisplayMain();
            
            isLoading = true;
            
            const languageInstruction = userData.language !== 'en' ? `Please respond in ${LANGUAGES[userData.language]}. ` : '';
            
            const context = `
                ${languageInstruction}You are FasalMitra, an expert agricultural AI assistant. Only answer questions related to farming, agriculture, crops, soil, weather, diseases, pests, fertilizers, and agricultural practices. If asked about non-agricultural topics, politely redirect to agricultural matters.
                
                Farmer Profile:
                - Name: ${userData.nickname}
                - Location: ${userData.location.city}
                - Land Area: ${userData.landArea} acres
                - Soil Type: ${userData.soilType}
                - Mode: ${userData.mode}
                ${userData.mode === 'advanced' && userData.advancedData ? `
                - pH Level: ${userData.advancedData.phValue}
                - N-P-K Values: ${userData.advancedData.nitrogen}-${userData.advancedData.phosphorus}-${userData.advancedData.potassium}
                - Organic Matter: ${userData.advancedData.organicMatter}%` : ''}
                
                Current Weather: ${weatherData ? `${weatherData.main.temp}°C, ${weatherData.weather[0].description}` : 'Not available'}
                
                Current Question: ${message}
                
                Provide helpful, accurate agricultural advice in simple language appropriate for ${userData.mode} mode. Use ** for bold text when emphasizing important points. ${userData.mode === 'advanced' ? 'Include technical details and specific recommendations based on soil chemistry data.' : 'Keep explanations simple and practical for general farming.'}
            `;
            
            const aiResponse = await getCropAdvice(context, userData.language);
            
            chatMessages.push({
                role: 'assistant',
                content: aiResponse,
                timestamp: new Date()
            });
            
            isLoading = false;
            updateChatDisplayMain();
            
            // Speak response if voice assistant is active
            if (isVoiceAssistantActive) {
                // Clean text for speech (remove markdown and emojis)
                const cleanText = aiResponse.replace(/\*\*(.*?)\*\*/g, '$1').replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
                speakText(cleanText);
            }
        }

        // Microphone functionality (legacy - will be replaced)
        // Variables moved to top of script

        function toggleMicrophone() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            } else {
                showToast('Speech recognition not supported in this browser', 'error');
            }
        }

        function startRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = userData?.language === 'hi' ? 'hi-IN' : 
                             userData?.language === 'pa' ? 'pa-IN' : 
                             userData?.language === 'mr' ? 'mr-IN' : 
                             userData?.language === 'ta' ? 'ta-IN' : 
                             userData?.language === 'te' ? 'te-IN' : 
                             userData?.language === 'gu' ? 'gu-IN' : 
                             userData?.language === 'kn' ? 'kn-IN' : 'en-US';
            
            recognition.onstart = function() {
                isRecording = true;
                const micBtn = document.getElementById('mic-button');
                micBtn.style.backgroundColor = 'hsl(var(--destructive))';
                micBtn.style.color = 'white';
                showToast('Listening...', 'info');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('chat-input-main').value = transcript;
            };
            
            recognition.onerror = function(event) {
                showToast('Speech recognition error: ' + event.error, 'error');
                stopRecording();
            };
            
            recognition.onend = function() {
                stopRecording();
            };
            
            recognition.start();
        }

        // Feature Functions
        function openCommunityForum() {
            const message = "Community Forum - Connect with farmers in your area to share experiences, ask questions, and get advice. Here are some popular discussion topics:\n\n🌾 Recent Crop Yields & Tips\n🌧️ Weather Updates & Irrigation\n🐛 Pest Control Solutions\n💰 Market Price Discussions\n🎯 Success Stories & Challenges\n\nAsk me anything about farming or share your experiences!";
            
            chatMessages.push({
                role: 'assistant',
                content: message,
                timestamp: new Date()
            });
            
            updateChatDisplayMain();
            showToast('Community Forum opened', 'success');
        }
        
        function openAlerts() {
            const alerts = [
                "🌧️ Weather Alert: Light rain expected in 2 days - Good for sowing",
                "🐛 Pest Alert: Aphid activity reported in nearby farms",
                "💰 Price Alert: Wheat prices trending upward - Consider holding stock",
                "🌱 Crop Alert: Optimal time for fertilizer application",
                "🚨 Irrigation Alert: Water levels low - Monitor closely"
            ];
            
            const message = "Alerts & Notifications:\n\n" + alerts.join("\n") + "\n\nWould you like detailed information about any of these alerts?";
            
            chatMessages.push({
                role: 'assistant',
                content: message,
                timestamp: new Date()
            });
            
            updateChatDisplayMain();
            showToast('Alerts loaded', 'success');
        }
        
        function openGovSchemes() {
            const schemes = [
                "🏦 PM-KISAN: ₹6000 annual income support",
                "🌾 Crop Insurance: Weather-based crop insurance",
                "💰 KCC (Kisan Credit Card): Low-interest agricultural loans",
                "🚜 Equipment Subsidy: 50-80% subsidy on farm machinery",
                "🌱 Organic Farming: Financial assistance for organic certification",
                "💧 Drip Irrigation: Up to 90% subsidy on water-saving systems"
            ];
            
            const message = "Government Schemes Available:\n\n" + schemes.join("\n") + "\n\nAsk me about eligibility criteria or application process for any scheme!";
            
            chatMessages.push({
                role: 'assistant',
                content: message,
                timestamp: new Date()
            });
            
            updateChatDisplayMain();
            showToast('Government schemes loaded', 'success');
        }
        
        function openInsurance() {
            const insuranceOptions = [
                "🛡️ Crop Insurance (PMFBY): Coverage against weather risks",
                "💵 Kisan Credit Card: Credit limit up to ₹3 lakh",
                "🏦 SHG Loans: Self-help group microcredit",
                "🚜 Equipment Loans: Financing for tractors & machinery",
                "🌾 Warehouse Receipt Loans: Against stored produce",
                "📊 Term Insurance: Life coverage for farmers"
            ];
            
            const message = "Insurance & Loan Options:\n\n" + insuranceOptions.join("\n") + "\n\nNeed help with loan applications or insurance claims? Ask me!";
            
            chatMessages.push({
                role: 'assistant',
                content: message,
                timestamp: new Date()
            });
            
            updateChatDisplayMain();
            showToast('Insurance options loaded', 'success');
        }
        
        function openMarketAnalytics() {
            const marketData = [
                "🌾 Wheat: ₹2,150/quintal (↑ 3% from last week)",
                "🌾 Rice: ₹1,890/quintal (↓ 1.5% from last week)",
                "🌽 Maize: ₹1,750/quintal (→ Stable)",
                "☘️ Cotton: ₹5,800/quintal (↑ 5% from last week)",
                "🧅 Onion: ₹25/kg (↓ 8% from last week)",
                "🍅 Tomato: ₹18/kg (↑ 12% from last week)"
            ];
            
            const message = "Market Analytics - Current Prices:\n\n" + marketData.join("\n") + "\n\n📈 Trend Analysis:\n- Wheat showing strong upward trend\n- Vegetable prices volatile due to weather\n- Cotton demand increasing\n\nAsk for specific crop price forecasts!";
            
            chatMessages.push({
                role: 'assistant',
                content: message,
                timestamp: new Date()
            });
            
            updateChatDisplayMain();
            showToast('Market analytics loaded', 'success');
        }
        
        function openSubsidyTracker() {
            const subsidyInfo = [
                "💰 Fertilizer Subsidy: Track your DBT payments",
                "🚜 Machinery Subsidy: Application status & disbursement",
                "💧 Irrigation Subsidy: Drip/sprinkler system support",
                "🌱 Seed Subsidy: Quality seed distribution program",
                "⚡ Solar Pump Subsidy: Renewable energy support",
                "🏭 Warehouse Subsidy: Storage infrastructure development"
            ];
            
            const message = "Subsidy Tracker:\n\n" + subsidyInfo.join("\n") + "\n\n📋 Your Subsidy Status:\n- Fertilizer DBT: ₹4,200 (Credited)\n- Drip Irrigation: Application Under Review\n- Solar Pump: Eligible (Apply Now)\n\nNeed help tracking or applying for subsidies?";
            
            chatMessages.push({
                role: 'assistant',
                content: message,
                timestamp: new Date()
            });
            
            updateChatDisplayMain();
            showToast('Subsidy tracker opened', 'success');
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            const micBtn = document.getElementById('mic-button');
            micBtn.style.backgroundColor = '';
            micBtn.style.color = '';
        }

        // Image modal and drag & drop functionality
        function openImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
            `;
            
            modal.innerHTML = `
                <img src="${imageSrc}" style="max-width: 90%; max-height: 90%; border-radius: 0.5rem;" alt="Full size image">
                <button onclick="this.parentElement.remove()" 
                        style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); 
                               border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">
                    ×
                </button>
            `;
            
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }
        
        // Initialize icons when page loads
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Add drag & drop functionality for sidebar
            const sidebarUploadArea = document.getElementById('sidebar-image-upload-area');
            
            if (sidebarUploadArea) {
                sidebarUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    sidebarUploadArea.style.borderColor = 'hsl(var(--primary))';
                    sidebarUploadArea.style.backgroundColor = 'hsl(var(--primary) / 0.2)';
                });
                
                sidebarUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    sidebarUploadArea.style.borderColor = 'hsl(var(--border))';
                    sidebarUploadArea.style.backgroundColor = 'hsl(var(--muted) / 0.3)';
                });
                
                sidebarUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    sidebarUploadArea.style.borderColor = 'hsl(var(--border))';
                    sidebarUploadArea.style.backgroundColor = 'hsl(var(--muted) / 0.3)';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById('sidebar-plant-image-input');
                        fileInput.files = files;
                        handleSidebarImageUpload({ target: { files } });
                    }
                });
            }
            
            // Add drag & drop functionality for main upload area (if exists)
            const uploadArea = document.getElementById('image-upload-area');
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'hsl(var(--primary))';
                    uploadArea.style.backgroundColor = 'hsl(var(--primary) / 0.1)';
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'hsl(var(--border))';
                    uploadArea.style.backgroundColor = 'hsl(var(--muted) / 0.3)';
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'hsl(var(--border))';
                    uploadArea.style.backgroundColor = 'hsl(var(--muted) / 0.3)';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById('plant-image-input');
                        fileInput.files = files;
                        handleImageUpload({ target: { files } });
                    }
                });
            }
        });
    </script>
</body>
</html>
